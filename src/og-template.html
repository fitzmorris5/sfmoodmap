<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SF Mood Map — Daily Card</title>
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
      body{margin:0;background:#0a0a0a;color:#fff;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
      .wrap{width:1200px;height:630px;display:grid;grid-template-columns:1fr 360px}
      header{grid-column:1/3;display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #222}
      #map{width:100%;height:520px}
      aside{border-left:1px solid #222;padding:16px;}
      h1{font-size:22px;margin:0;font-weight:600}
      .muted{color:#aaa;font-size:14px}
      ol{margin:6px 0 12px 18px;font-size:14px}
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Today’s Mood of SF</h1>
        <div class="muted" id="date">—</div>
      </header>
      <div id="map"></div>
      <aside>
        <div class="muted">Top 3 neighborhoods</div>
        <ol id="top3"></ol>
        <div class="muted">Data: SF 311 (Socrata)</div>
      </aside>
    </div>
    <script type="module">
      import maplibregl from 'https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.esm.js';
      const res = await fetch(new URL('../public/sf-neighborhoods.geojson', import.meta.url));
      const geo = await res.json();
      const params = new URLSearchParams(location.search);
      const color = (m)=>({positive:'#00C853',neutral:'#FFD54F',negative:'#FF5252',anxious:'#7E57C2',excited:'#29B6F6'})[m]||'#BDBDBD';
      const byName = JSON.parse(params.get('stats')||'{}');

      const map = new maplibregl.Map({
        container: 'map',
        style: {version:8, sources:{}, layers:[{id:'bg',type:'background',paint:{'background-color':'#efefef'}}]},
        center: [-122.4376, 37.7577], zoom: 11.2
      });
      await new Promise(r=>map.once('load', r));
      geo.features = geo.features.map(f=>{
        const n=(f.properties.name||f.properties.Name||'').toLowerCase();
        const m=byName[n]?.mood||'neutral';
        return {...f, properties:{...f.properties, _color: color(m)}}
      });
      map.addSource('hoods',{type:'geojson', data: geo});
      map.addLayer({id:'fills', type:'fill', source:'hoods', paint:{'fill-color':['get','_color'],'fill-opacity':0.6}});
      map.addLayer({id:'borders', type:'line', source:'hoods', paint:{'line-color':'#fff','line-width':0.6}});
      document.getElementById('date').textContent = new Date().toLocaleDateString();
      const top3 = Object.entries(byName).slice(0,3).map(([name,val])=>`<li>${name.replace(/\b\w/g,c=>c.toUpperCase())} — ${val.mood}</li>`).join('');
      document.getElementById('top3').innerHTML = top3;
    </script>
  </body>
</html>
